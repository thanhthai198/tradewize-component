{"version":3,"names":["_react","_interopRequireWildcard","require","_reactNative","_Message","_interopRequireDefault","_reactNativeReanimated","_Day","_utils","_types","Object","keys","forEach","key","prototype","hasOwnProperty","call","_exportNames","exports","defineProperty","enumerable","get","e","__esModule","default","t","WeakMap","r","n","o","i","f","__proto__","has","set","getOwnPropertyDescriptor","_extends","assign","bind","arguments","length","apply","useAbsoluteScrolledPositionToBottomOfDay","listHeight","scrolledY","containerHeight","dayBottomMargin","dayTopOffset","absoluteScrolledPositionToBottomOfDay","useDerivedValue","value","useRelativeScrolledPositionToBottomOfDay","daysPositions","createdAt","dayMarginTop","useMemo","daysPositionsArray","values","sort","a","b","y","currentDayPosition","find","day","index","dayPosition","height","relativeScrolledPositionToBottomOfDay","_currentDayPosition$v","_currentDayPosition$v2","scrolledBottomY","DayWrapper","forwardRef","props","ref","renderDay","renderDayProp","currentMessage","previousMessage","isSameDay","containerStyle","onMessageLayout","rest","createElement","View","Day","Item","renderMessage","renderMessageProp","onPressFile","onLongPressReaction","dayContainerHeight","useSharedValue","Date","getTime","handleLayoutDayContainer","useCallback","nativeEvent","layout","style","useAnimatedStyle","opacity","interpolate","_id","toString","onLayout","_default"],"sources":["index.tsx"],"sourcesContent":["import React, { forwardRef, useCallback, useMemo } from 'react';\r\nimport { type LayoutChangeEvent, View } from 'react-native';\r\nimport { type IMessage } from '../../../types';\r\nimport Message, { type MessageProps } from '../../../Message';\r\nimport Animated, {\r\n  interpolate,\r\n  useAnimatedStyle,\r\n  useDerivedValue,\r\n  useSharedValue,\r\n} from 'react-native-reanimated';\r\nimport { type DaysPositions } from '../../types';\r\nimport { Day } from '../../../Day';\r\nimport { isSameDay } from '../../../utils';\r\nimport { type ItemProps } from './types';\r\n\r\nexport * from './types';\r\n\r\n// y-position of current scroll position relative to the bottom of the day container. (since we have inverted list it is bottom)\r\nexport const useAbsoluteScrolledPositionToBottomOfDay = (\r\n  listHeight: { value: number },\r\n  scrolledY: { value: number },\r\n  containerHeight: { value: number },\r\n  dayBottomMargin: number,\r\n  dayTopOffset: number\r\n) => {\r\n  const absoluteScrolledPositionToBottomOfDay = useDerivedValue(\r\n    () =>\r\n      listHeight.value +\r\n      scrolledY.value -\r\n      containerHeight.value -\r\n      dayBottomMargin -\r\n      dayTopOffset,\r\n    [listHeight, scrolledY, containerHeight, dayBottomMargin, dayTopOffset]\r\n  );\r\n\r\n  return absoluteScrolledPositionToBottomOfDay;\r\n};\r\n\r\nexport const useRelativeScrolledPositionToBottomOfDay = (\r\n  listHeight: { value: number },\r\n  scrolledY: { value: number },\r\n  daysPositions: { value: DaysPositions },\r\n  containerHeight: { value: number },\r\n  dayBottomMargin: number,\r\n  dayTopOffset: number,\r\n  createdAt?: number\r\n) => {\r\n  const dayMarginTop = useMemo(() => 5, []);\r\n\r\n  const absoluteScrolledPositionToBottomOfDay =\r\n    useAbsoluteScrolledPositionToBottomOfDay(\r\n      listHeight,\r\n      scrolledY,\r\n      containerHeight,\r\n      dayBottomMargin,\r\n      dayTopOffset\r\n    );\r\n\r\n  // sorted array of days positions by y\r\n  const daysPositionsArray = useDerivedValue(() =>\r\n    Object.values(daysPositions.value).sort((a, b) => a.y - b.y)\r\n  );\r\n\r\n  // find current day position by scrolled position\r\n  const currentDayPosition = useDerivedValue(() => {\r\n    if (createdAt != null) {\r\n      const currentDayPosition = daysPositionsArray.value.find(\r\n        (day) => day.createdAt === createdAt\r\n      );\r\n      if (currentDayPosition) return currentDayPosition;\r\n    }\r\n\r\n    return daysPositionsArray.value.find((day, index) => {\r\n      const dayPosition = day.y + day.height;\r\n      return (\r\n        absoluteScrolledPositionToBottomOfDay.value < dayPosition ||\r\n        index === daysPositionsArray.value.length - 1\r\n      );\r\n    });\r\n  }, [daysPositionsArray, absoluteScrolledPositionToBottomOfDay, createdAt]);\r\n\r\n  const relativeScrolledPositionToBottomOfDay = useDerivedValue(() => {\r\n    const scrolledBottomY =\r\n      listHeight.value +\r\n      scrolledY.value -\r\n      ((currentDayPosition.value?.y ?? 0) +\r\n        (currentDayPosition.value?.height ?? 0) +\r\n        dayMarginTop);\r\n\r\n    return scrolledBottomY;\r\n  }, [listHeight, scrolledY, currentDayPosition, dayMarginTop]);\r\n\r\n  return relativeScrolledPositionToBottomOfDay;\r\n};\r\n\r\nconst DayWrapper = forwardRef<View, MessageProps<IMessage>>((props, ref) => {\r\n  const { renderDay: renderDayProp, currentMessage, previousMessage } = props;\r\n\r\n  if (!currentMessage?.createdAt || isSameDay(currentMessage, previousMessage))\r\n    return null;\r\n\r\n  const {\r\n    /* eslint-disable @typescript-eslint/no-unused-vars */\r\n    containerStyle,\r\n    onMessageLayout,\r\n    /* eslint-enable @typescript-eslint/no-unused-vars */\r\n    ...rest\r\n  } = props;\r\n\r\n  return (\r\n    <View ref={ref}>\r\n      {renderDayProp ? (\r\n        renderDayProp({ ...rest, createdAt: currentMessage.createdAt })\r\n      ) : (\r\n        <Day {...rest} createdAt={currentMessage.createdAt} />\r\n      )}\r\n    </View>\r\n  );\r\n});\r\n\r\nconst Item = <TMessage extends IMessage>(props: ItemProps<TMessage>) => {\r\n  const {\r\n    renderMessage: renderMessageProp,\r\n    scrolledY,\r\n    daysPositions,\r\n    listHeight,\r\n    onPressFile,\r\n    onLongPressReaction,\r\n    ...rest\r\n  } = props;\r\n\r\n  const dayContainerHeight = useSharedValue(0);\r\n  const dayTopOffset = useMemo(() => 10, []);\r\n  const dayBottomMargin = useMemo(() => 10, []);\r\n\r\n  const createdAt = useMemo(\r\n    () => new Date(props.currentMessage.createdAt).getTime(),\r\n    [props.currentMessage.createdAt]\r\n  );\r\n\r\n  const relativeScrolledPositionToBottomOfDay =\r\n    useRelativeScrolledPositionToBottomOfDay(\r\n      listHeight,\r\n      scrolledY,\r\n      daysPositions,\r\n      dayContainerHeight,\r\n      dayBottomMargin,\r\n      dayTopOffset,\r\n      createdAt\r\n    );\r\n\r\n  const handleLayoutDayContainer = useCallback(\r\n    ({ nativeEvent }: LayoutChangeEvent) => {\r\n      dayContainerHeight.value = nativeEvent.layout.height;\r\n    },\r\n    [dayContainerHeight]\r\n  );\r\n\r\n  const style = useAnimatedStyle(\r\n    () => ({\r\n      opacity: interpolate(\r\n        relativeScrolledPositionToBottomOfDay.value,\r\n        [-dayTopOffset, -0.0001, 0, dayContainerHeight.value + dayTopOffset],\r\n        [0, 0, 1, 1],\r\n        'clamp'\r\n      ),\r\n    }),\r\n    [relativeScrolledPositionToBottomOfDay, dayContainerHeight, dayTopOffset]\r\n  );\r\n\r\n  return (\r\n    // do not remove key. it helps to get correct position of the day container\r\n    <View key={props.currentMessage._id.toString()}>\r\n      <Animated.View style={style} onLayout={handleLayoutDayContainer}>\r\n        <DayWrapper {...(rest as MessageProps<TMessage>)} />\r\n      </Animated.View>\r\n      {renderMessageProp ? (\r\n        renderMessageProp(rest as MessageProps<TMessage>)\r\n      ) : (\r\n        <Message\r\n          {...(rest as MessageProps<TMessage>)}\r\n          onPressFile={onPressFile}\r\n          onLongPressReaction={onLongPressReaction}\r\n        />\r\n      )}\r\n    </View>\r\n  );\r\n};\r\n\r\nexport default Item;\r\n"],"mappings":"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","ignoreList":[]}