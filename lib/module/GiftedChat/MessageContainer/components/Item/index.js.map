{"version":3,"names":["React","forwardRef","useCallback","useMemo","View","Message","Animated","interpolate","useAnimatedStyle","useDerivedValue","useSharedValue","Day","isSameDay","useAbsoluteScrolledPositionToBottomOfDay","listHeight","scrolledY","containerHeight","dayBottomMargin","dayTopOffset","absoluteScrolledPositionToBottomOfDay","value","useRelativeScrolledPositionToBottomOfDay","daysPositions","createdAt","dayMarginTop","daysPositionsArray","Object","values","sort","a","b","y","currentDayPosition","find","day","index","dayPosition","height","length","relativeScrolledPositionToBottomOfDay","_currentDayPosition$v","_currentDayPosition$v2","scrolledBottomY","DayWrapper","props","ref","renderDay","renderDayProp","currentMessage","previousMessage","containerStyle","onMessageLayout","rest","createElement","_extends","Item","renderMessage","renderMessageProp","onPressFile","onLongPressReaction","dayContainerHeight","Date","getTime","handleLayoutDayContainer","nativeEvent","layout","style","opacity","key","_id","toString","onLayout"],"sources":["index.tsx"],"sourcesContent":["import React, { forwardRef, useCallback, useMemo } from 'react';\r\nimport { type LayoutChangeEvent, View } from 'react-native';\r\nimport { type IMessage } from '../../../types';\r\nimport Message, { type MessageProps } from '../../../Message';\r\nimport Animated, {\r\n  interpolate,\r\n  useAnimatedStyle,\r\n  useDerivedValue,\r\n  useSharedValue,\r\n} from 'react-native-reanimated';\r\nimport { type DaysPositions } from '../../types';\r\nimport { Day } from '../../../Day';\r\nimport { isSameDay } from '../../../utils';\r\nimport { type ItemProps } from './types';\r\n\r\nexport * from './types';\r\n\r\n// y-position of current scroll position relative to the bottom of the day container. (since we have inverted list it is bottom)\r\nexport const useAbsoluteScrolledPositionToBottomOfDay = (\r\n  listHeight: { value: number },\r\n  scrolledY: { value: number },\r\n  containerHeight: { value: number },\r\n  dayBottomMargin: number,\r\n  dayTopOffset: number\r\n) => {\r\n  const absoluteScrolledPositionToBottomOfDay = useDerivedValue(\r\n    () =>\r\n      listHeight.value +\r\n      scrolledY.value -\r\n      containerHeight.value -\r\n      dayBottomMargin -\r\n      dayTopOffset,\r\n    [listHeight, scrolledY, containerHeight, dayBottomMargin, dayTopOffset]\r\n  );\r\n\r\n  return absoluteScrolledPositionToBottomOfDay;\r\n};\r\n\r\nexport const useRelativeScrolledPositionToBottomOfDay = (\r\n  listHeight: { value: number },\r\n  scrolledY: { value: number },\r\n  daysPositions: { value: DaysPositions },\r\n  containerHeight: { value: number },\r\n  dayBottomMargin: number,\r\n  dayTopOffset: number,\r\n  createdAt?: number\r\n) => {\r\n  const dayMarginTop = useMemo(() => 5, []);\r\n\r\n  const absoluteScrolledPositionToBottomOfDay =\r\n    useAbsoluteScrolledPositionToBottomOfDay(\r\n      listHeight,\r\n      scrolledY,\r\n      containerHeight,\r\n      dayBottomMargin,\r\n      dayTopOffset\r\n    );\r\n\r\n  // sorted array of days positions by y\r\n  const daysPositionsArray = useDerivedValue(() =>\r\n    Object.values(daysPositions.value).sort((a, b) => a.y - b.y)\r\n  );\r\n\r\n  // find current day position by scrolled position\r\n  const currentDayPosition = useDerivedValue(() => {\r\n    if (createdAt != null) {\r\n      const currentDayPosition = daysPositionsArray.value.find(\r\n        (day) => day.createdAt === createdAt\r\n      );\r\n      if (currentDayPosition) return currentDayPosition;\r\n    }\r\n\r\n    return daysPositionsArray.value.find((day, index) => {\r\n      const dayPosition = day.y + day.height;\r\n      return (\r\n        absoluteScrolledPositionToBottomOfDay.value < dayPosition ||\r\n        index === daysPositionsArray.value.length - 1\r\n      );\r\n    });\r\n  }, [daysPositionsArray, absoluteScrolledPositionToBottomOfDay, createdAt]);\r\n\r\n  const relativeScrolledPositionToBottomOfDay = useDerivedValue(() => {\r\n    const scrolledBottomY =\r\n      listHeight.value +\r\n      scrolledY.value -\r\n      ((currentDayPosition.value?.y ?? 0) +\r\n        (currentDayPosition.value?.height ?? 0) +\r\n        dayMarginTop);\r\n\r\n    return scrolledBottomY;\r\n  }, [listHeight, scrolledY, currentDayPosition, dayMarginTop]);\r\n\r\n  return relativeScrolledPositionToBottomOfDay;\r\n};\r\n\r\nconst DayWrapper = forwardRef<View, MessageProps<IMessage>>((props, ref) => {\r\n  const { renderDay: renderDayProp, currentMessage, previousMessage } = props;\r\n\r\n  if (!currentMessage?.createdAt || isSameDay(currentMessage, previousMessage))\r\n    return null;\r\n\r\n  const {\r\n    /* eslint-disable @typescript-eslint/no-unused-vars */\r\n    containerStyle,\r\n    onMessageLayout,\r\n    /* eslint-enable @typescript-eslint/no-unused-vars */\r\n    ...rest\r\n  } = props;\r\n\r\n  return (\r\n    <View ref={ref}>\r\n      {renderDayProp ? (\r\n        renderDayProp({ ...rest, createdAt: currentMessage.createdAt })\r\n      ) : (\r\n        <Day {...rest} createdAt={currentMessage.createdAt} />\r\n      )}\r\n    </View>\r\n  );\r\n});\r\n\r\nconst Item = <TMessage extends IMessage>(props: ItemProps<TMessage>) => {\r\n  const {\r\n    renderMessage: renderMessageProp,\r\n    scrolledY,\r\n    daysPositions,\r\n    listHeight,\r\n    onPressFile,\r\n    onLongPressReaction,\r\n    ...rest\r\n  } = props;\r\n\r\n  const dayContainerHeight = useSharedValue(0);\r\n  const dayTopOffset = useMemo(() => 10, []);\r\n  const dayBottomMargin = useMemo(() => 10, []);\r\n\r\n  const createdAt = useMemo(\r\n    () => new Date(props.currentMessage.createdAt).getTime(),\r\n    [props.currentMessage.createdAt]\r\n  );\r\n\r\n  const relativeScrolledPositionToBottomOfDay =\r\n    useRelativeScrolledPositionToBottomOfDay(\r\n      listHeight,\r\n      scrolledY,\r\n      daysPositions,\r\n      dayContainerHeight,\r\n      dayBottomMargin,\r\n      dayTopOffset,\r\n      createdAt\r\n    );\r\n\r\n  const handleLayoutDayContainer = useCallback(\r\n    ({ nativeEvent }: LayoutChangeEvent) => {\r\n      dayContainerHeight.value = nativeEvent.layout.height;\r\n    },\r\n    [dayContainerHeight]\r\n  );\r\n\r\n  const style = useAnimatedStyle(\r\n    () => ({\r\n      opacity: interpolate(\r\n        relativeScrolledPositionToBottomOfDay.value,\r\n        [-dayTopOffset, -0.0001, 0, dayContainerHeight.value + dayTopOffset],\r\n        [0, 0, 1, 1],\r\n        'clamp'\r\n      ),\r\n    }),\r\n    [relativeScrolledPositionToBottomOfDay, dayContainerHeight, dayTopOffset]\r\n  );\r\n\r\n  return (\r\n    // do not remove key. it helps to get correct position of the day container\r\n    <View key={props.currentMessage._id.toString()}>\r\n      <Animated.View style={style} onLayout={handleLayoutDayContainer}>\r\n        <DayWrapper {...(rest as MessageProps<TMessage>)} />\r\n      </Animated.View>\r\n      {renderMessageProp ? (\r\n        renderMessageProp(rest as MessageProps<TMessage>)\r\n      ) : (\r\n        <Message\r\n          {...(rest as MessageProps<TMessage>)}\r\n          onPressFile={onPressFile}\r\n          onLongPressReaction={onLongPressReaction}\r\n        />\r\n      )}\r\n    </View>\r\n  );\r\n};\r\n\r\nexport default Item;\r\n"],"mappings":"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","ignoreList":[]}