{"version":3,"names":["forwardRef","useCallback","useMemo","View","Message","Animated","interpolate","useAnimatedStyle","useDerivedValue","useSharedValue","Day","isSameDay","useAbsoluteScrolledPositionToBottomOfDay","listHeight","scrolledY","containerHeight","dayBottomMargin","dayTopOffset","absoluteScrolledPositionToBottomOfDay","value","useRelativeScrolledPositionToBottomOfDay","daysPositions","createdAt","dayMarginTop","daysPositionsArray","Object","values","sort","a","b","y","currentDayPosition","find","day","index","dayPosition","height","length","relativeScrolledPositionToBottomOfDay","_currentDayPosition$v","_currentDayPosition$v2","scrolledBottomY","DayWrapper","props","ref","renderDay","renderDayProp","currentMessage","previousMessage","containerStyle","onMessageLayout","rest","React","createElement","_extends","Item","renderMessage","renderMessageProp","onPressFile","onLongPressReaction","dayContainerHeight","Date","getTime","handleLayoutDayContainer","nativeEvent","layout","style","opacity","key","_id","toString","onLayout"],"sources":["index.tsx"],"sourcesContent":["import { forwardRef, useCallback, useMemo } from 'react';\nimport { type LayoutChangeEvent, View } from 'react-native';\nimport { type IMessage } from '../../../types';\nimport Message, { type MessageProps } from '../../../Message';\nimport Animated, {\n  interpolate,\n  useAnimatedStyle,\n  useDerivedValue,\n  useSharedValue,\n} from 'react-native-reanimated';\nimport { type DaysPositions } from '../../types';\nimport { Day } from '../../../Day';\nimport { isSameDay } from '../../../utils';\nimport { type ItemProps } from './types';\n\nexport * from './types';\n\n// y-position of current scroll position relative to the bottom of the day container. (since we have inverted list it is bottom)\nexport const useAbsoluteScrolledPositionToBottomOfDay = (\n  listHeight: { value: number },\n  scrolledY: { value: number },\n  containerHeight: { value: number },\n  dayBottomMargin: number,\n  dayTopOffset: number\n) => {\n  const absoluteScrolledPositionToBottomOfDay = useDerivedValue(\n    () =>\n      listHeight.value +\n      scrolledY.value -\n      containerHeight.value -\n      dayBottomMargin -\n      dayTopOffset,\n    [listHeight, scrolledY, containerHeight, dayBottomMargin, dayTopOffset]\n  );\n\n  return absoluteScrolledPositionToBottomOfDay;\n};\n\nexport const useRelativeScrolledPositionToBottomOfDay = (\n  listHeight: { value: number },\n  scrolledY: { value: number },\n  daysPositions: { value: DaysPositions },\n  containerHeight: { value: number },\n  dayBottomMargin: number,\n  dayTopOffset: number,\n  createdAt?: number\n) => {\n  const dayMarginTop = useMemo(() => 5, []);\n\n  const absoluteScrolledPositionToBottomOfDay =\n    useAbsoluteScrolledPositionToBottomOfDay(\n      listHeight,\n      scrolledY,\n      containerHeight,\n      dayBottomMargin,\n      dayTopOffset\n    );\n\n  // sorted array of days positions by y\n  const daysPositionsArray = useDerivedValue(() =>\n    Object.values(daysPositions.value).sort((a, b) => a.y - b.y)\n  );\n\n  // find current day position by scrolled position\n  const currentDayPosition = useDerivedValue(() => {\n    if (createdAt != null) {\n      const currentDayPosition = daysPositionsArray.value.find(\n        (day) => day.createdAt === createdAt\n      );\n      if (currentDayPosition) return currentDayPosition;\n    }\n\n    return daysPositionsArray.value.find((day, index) => {\n      const dayPosition = day.y + day.height;\n      return (\n        absoluteScrolledPositionToBottomOfDay.value < dayPosition ||\n        index === daysPositionsArray.value.length - 1\n      );\n    });\n  }, [daysPositionsArray, absoluteScrolledPositionToBottomOfDay, createdAt]);\n\n  const relativeScrolledPositionToBottomOfDay = useDerivedValue(() => {\n    const scrolledBottomY =\n      listHeight.value +\n      scrolledY.value -\n      ((currentDayPosition.value?.y ?? 0) +\n        (currentDayPosition.value?.height ?? 0) +\n        dayMarginTop);\n\n    return scrolledBottomY;\n  }, [listHeight, scrolledY, currentDayPosition, dayMarginTop]);\n\n  return relativeScrolledPositionToBottomOfDay;\n};\n\nconst DayWrapper = forwardRef<View, MessageProps<IMessage>>((props, ref) => {\n  const { renderDay: renderDayProp, currentMessage, previousMessage } = props;\n\n  if (!currentMessage?.createdAt || isSameDay(currentMessage, previousMessage))\n    return null;\n\n  const {\n    /* eslint-disable @typescript-eslint/no-unused-vars */\n    containerStyle,\n    onMessageLayout,\n    /* eslint-enable @typescript-eslint/no-unused-vars */\n    ...rest\n  } = props;\n\n  return (\n    <View ref={ref}>\n      {renderDayProp ? (\n        renderDayProp({ ...rest, createdAt: currentMessage.createdAt })\n      ) : (\n        <Day {...rest} createdAt={currentMessage.createdAt} />\n      )}\n    </View>\n  );\n});\n\nconst Item = <TMessage extends IMessage>(props: ItemProps<TMessage>) => {\n  const {\n    renderMessage: renderMessageProp,\n    scrolledY,\n    daysPositions,\n    listHeight,\n    onPressFile,\n    onLongPressReaction,\n    ...rest\n  } = props;\n\n  const dayContainerHeight = useSharedValue(0);\n  const dayTopOffset = useMemo(() => 10, []);\n  const dayBottomMargin = useMemo(() => 10, []);\n\n  const createdAt = useMemo(\n    () => new Date(props.currentMessage.createdAt).getTime(),\n    [props.currentMessage.createdAt]\n  );\n\n  const relativeScrolledPositionToBottomOfDay =\n    useRelativeScrolledPositionToBottomOfDay(\n      listHeight,\n      scrolledY,\n      daysPositions,\n      dayContainerHeight,\n      dayBottomMargin,\n      dayTopOffset,\n      createdAt\n    );\n\n  const handleLayoutDayContainer = useCallback(\n    ({ nativeEvent }: LayoutChangeEvent) => {\n      dayContainerHeight.value = nativeEvent.layout.height;\n    },\n    [dayContainerHeight]\n  );\n\n  const style = useAnimatedStyle(\n    () => ({\n      opacity: interpolate(\n        relativeScrolledPositionToBottomOfDay.value,\n        [-dayTopOffset, -0.0001, 0, dayContainerHeight.value + dayTopOffset],\n        [0, 0, 1, 1],\n        'clamp'\n      ),\n    }),\n    [relativeScrolledPositionToBottomOfDay, dayContainerHeight, dayTopOffset]\n  );\n\n  return (\n    // do not remove key. it helps to get correct position of the day container\n    <View key={props.currentMessage._id.toString()}>\n      <Animated.View style={style} onLayout={handleLayoutDayContainer}>\n        <DayWrapper {...(rest as MessageProps<TMessage>)} />\n      </Animated.View>\n      {renderMessageProp ? (\n        renderMessageProp(rest as MessageProps<TMessage>)\n      ) : (\n        <Message\n          {...(rest as MessageProps<TMessage>)}\n          onPressFile={onPressFile}\n          onLongPressReaction={onLongPressReaction}\n        />\n      )}\n    </View>\n  );\n};\n\nexport default Item;\n"],"mappings":"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","ignoreList":[]}